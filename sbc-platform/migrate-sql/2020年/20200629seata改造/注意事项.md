#seata
需要部署seata-server
#nacos配置
nacos中的数据需要进行更改，注意nacos中的配置等号（=）两边不能有空格
##common.properties
中需要新增如下的配置
```properties
# mongo
mongo.transaction.enable=true
#-----------------------------------------------
#seata
#-----------------------------------------------
seata.enabled=true
seata.application-id=${spring.application.name}
#Seata事务组编号，用于TC集群名Seata服务配置项，对应ServiceProperties类
seata.tx-service-group=${spring.application.name}-group
seata.service.disable-global-transaction=false

seata.enableAutoDataSourceProxy=true
seata.registry.type=nacos
seata.registry.nacos.server-addr=172.19.25.55:8848
seata.registry.nacos.namespace=public
seata.registry.nacos.cluster=default
```
> 地址改为对应服务器的地址
## mysql.properties
配置改为
```properties
#----------------------------------------
#datasource
#----------------------------------------
spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.hikari.jdbc-url=jdbc:mysql://${wm.mysql.db.url}:3306/${wm.mysql.db.name}?characterEncoding=UTF-8&&zeroDateTimeBehavior=convertToNull&autoReconnect=true&failOverReadOnly=false&connectTimeout=0&serverTimezone=Asia/Shanghai&allowMultiQueries=true
spring.datasource.hikari.username=${wm.mysql.db.username}
spring.datasource.hikari.password=${wm.mysql.db.password}
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.maximum-pool-size=15
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.max-lifetime=60000
spring.datasource.hikari.connection-timeout=30000
```
## 服务配置
每个服务中添加配置（marketing 、message配置出外详细看下文）
```properties
#-----------------------------------------------
#seata
#-----------------------------------------------
seata.service.vgroup-mapping.sbc-service-pay-group=default
```
> 将sbc-service-pay改为当前服务的名称

其中marketing服务配置为
```properties
#-----------------------------------------------
# seata
#-----------------------------------------------
# 虚拟组和分组的映射
seata.sharding.enable=true
seata.service.vgroup-mapping.sbc-service-marketing-group=default
seata.enableAutoDataSourceProxy=false
```
message
```properties
#-----------------------------------------------
# seata
#-----------------------------------------------
seata.sharding.enable=true
# 虚拟组和分组的映射
seata.service.vgroup-mapping.sbc-service-message-group=default
#此处注意enable-auto-data-source-proxy不生效，要是驼峰
seata.enableAutoDataSourceProxy=false
```
# mongodb
mongodb的版本需要升级到4.2，用以支持事物
## 单机部署
mkdir db logs
vi mongo.conf
```properties
# 数据文件存放目录
dbpath = /data/mongodb/db
# 日志文件存放目录
logpath = /data/mongodb/logs/mongodb.log
# 端口
port = 27017
bind_ip=0.0.0.0
# 以守护程序方式启动，即在后台运行
fork = true
replSet = rs1
# 关闭http接口，默认关闭27018端口访问
#nohttpinterface=true
# 设置开启简单的rest API，设置后打开28017网页端口
#rest = true
```

启动
```shell script
./bin/mongod --config=./mongodb.conf
```
进入mongodb
bin/mongo

初始化
```shell script
rs.initiate({_id:"rs1",members:[{_id:0,host:'172.19.25.186:27017'}]},{"force":true});
```
## 集群部署
两台机器的配置一样，在两台机器上操作
mkdir db logs
vi mongo.conf
```properties
# 数据文件存放目录
dbpath = /data/mongodb/db
# 日志文件存放目录
logpath = /data/mongodb/logs/mongodb.log
# 端口
port = 27017
bind_ip=0.0.0.0
# 以守护程序方式启动，即在后台运行
fork = true
replSet = rs1
# 关闭http接口，默认关闭27018端口访问
#nohttpinterface=true
# 设置开启简单的rest API，设置后打开28017网页端口
#rest = true
```
启动
```shell
./bin/mongod --config=./mongodb.conf
```
两台机器都启动之主节点进入后初始化
```shell
rs.initiate({_id:"rs1",members:[{_id:0,host:'172.19.25.186:27017'},{_id:1,host:'172.19.25.187:27017'}]},{"force":true});
```
导入原来的数据

> 注意：mongo版本升级之后需要先手工的创建collection,对比下s2b是否有如下该collection，如果没有新增
```json
 [
     "appointmentRecord",
     "couponCache",
     "goodsCheckLog",
     "goodsMarketing",
     "grouponInstance",
     "hoverNavMobile",
     "logisticsLog",
     "myDataOne",
     "myDataTwo",
     "pageInfoExtend",
     "printSetting",
     "providerTrade",
     "returnOrder",
     "returnOrderTransfer",
     "settlementDetail",
     "trade",
     "tradeCouponSnapshot",
     "tradeGroup",
     "tradeItemSnapshot"
 ]
 ```